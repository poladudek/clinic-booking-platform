<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twój Grafik - System Rejestracji Wizyt</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="layout.css">

    <style>
        /* ========================================= */
        /* STYLE SPECYFICZNE DLA KALENDARZA I MODALA */
        /* ========================================= */

        /* Nawigacja tygodniowa */
        .schedule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .week-nav { display: flex; align-items: center; gap: 20px; font-size: 1.2rem; margin-bottom: 20px; font-weight: 500; }
        .arrow { cursor: pointer; font-size: 1.5rem; user-select: none; color: #5a80cc; transition: 0.2s; }
        .arrow:hover { color: #34457b; transform: scale(1.2); }

        /* Siatka Kalendarza */
        .calendar { border: 1px solid #ddd; overflow-y: auto; max-height: 600px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); background: #fff; }
        .calendar-header { display: grid; grid-template-columns: 80px repeat(7, 1fr); border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #f8fafc; z-index: 1; }
        .day-header { padding: 15px 5px; text-align: center; border-right: 1px solid #e0e0e0; font-weight: bold; font-size: clamp(12px, 1vw, 15px); color: #333; }

        .calendar-row { display: grid; grid-template-columns: 80px repeat(7, 1fr); min-height: 100px; border-bottom: 1px solid #e0e0e0; }
        .time-cell { padding: 10px; text-align: center; border-right: 1px solid #ddd; font-weight: bold; display: flex; align-items: flex-start; justify-content: center; color: #666; background: #fcfcfc; }

        .day-cell { border-right: 1px solid #e0e0e0; padding: 5px; cursor: pointer; position: relative; transition: background 0.2s; }
        .day-cell:hover { background: #f1f5f9; }

        /* Statusy komórek (kolory tła) */
        .day-cell.empty { background: white; }
        .day-cell.available { background: #dbeafe; /* jasny niebieski */ }
        .day-cell.unconfirmed { background: #fef3c7; /* jasny żółty */ }
        .day-cell.confirmed { background: #dcfce7; /* jasny zielony */ }
        .day-cell.cancelled { background: #fee2e2; /* jasny czerwony */ cursor: not-allowed; }

        .appointment {
            padding: 6px;
            margin-top: 5px;
            font-size: clamp(10px, 0.9vw, 12px);
            font-weight: 600;
            line-height: 1.3;
            background: rgba(255,255,255,0.6);
            border-radius: 4px;
            border-left: 3px solid rgba(0,0,0,0.1);
        }

        /* Stopka z legendą */
        .footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 15px; }
        .legend { display: flex; gap: 15px; border: 1px solid #ddd; padding: 10px 15px; background: white; border-radius: 8px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .legend-box { width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 4px; }

        /* Kolory legendy */
        .legend-confirmed { background: #dcfce7; }
        .legend-unconfirmed { background: #fef3c7; }
        .legend-available { background: #dbeafe; }
        .legend-cancelled { background: #fee2e2; }

        /* Modal (Okienko) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: white; margin: 10% auto; padding: 25px; border: 1px solid #ddd; width: 400px; max-width: 90%; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: fadeIn 0.2s; }
        .modal-buttons { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .close-modal { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #666; }
        .close-modal:hover { color: #000; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Checkboxy w modalu */
        .modal-option {
            margin: 5px 0; padding: 8px; border: 1px solid #eee; border-radius: 6px; background: #fafafa;
        }
        .modal-option label {
            display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.9rem;
        }
    </style>
</head>
<body>

<nav class="top-menu">
    <div class="top-left">
        <img src="images/logo.png" alt="Logo" id="logo">
    </div>
    <div class="nav-btns">
        <button class="nav-btn nav-link" onclick="window.location.href='index_doctor.html'">Strona główna</button>
        <button class="active-btn nav-link" onclick="window.location.href='date_management.html'">Mój grafik</button>
        <button class="nav-btn nav-link" onclick="window.location.href='patient_search.html'">Pacjenci</button>
        <button class="nav-btn nav-link">Historia Wizyt</button>
    </div>
</nav>

<div class="login-bar">
    <div>Zalogowano jako Anna Kowalska (Lekarz)</div>
    <button class="def-btn">Wyloguj</button>
</div>

<div class="section-container">
    <div class="schedule-header">
        <h2>Zarządzanie Grafikiem</h2>
        <div style="color: #666;"><strong id="currentDate"></strong></div>
    </div>

    <div class="week-nav">
        <span class="arrow" onclick="previousWeek()">&#10094;</span>
        <span id="weekRange" style="min-width: 220px; text-align: center;"></span>
        <span class="arrow" onclick="nextWeek()">&#10095;</span>
    </div>

    <div class="calendar">
        <div class="calendar-header">
            <div class="day-header">Godz.</div>
            <div class="day-header" id="day0"></div>
            <div class="day-header" id="day1"></div>
            <div class="day-header" id="day2"></div>
            <div class="day-header" id="day3"></div>
            <div class="day-header" id="day4"></div>
            <div class="day-header" id="day5"></div>
            <div class="day-header" id="day6"></div>
        </div>
        <div id="calendarBody"></div>
    </div>

    <div class="footer">
        <button class="action-btn" id="editBtn" onclick="toggleEditMode()">Edytuj godziny pracy</button>

        <div class="legend">
            <div class="legend-item"><div class="legend-box legend-confirmed"></div><span>Potwierdzona</span></div>
            <div class="legend-item"><div class="legend-box legend-unconfirmed"></div><span>Niepotwierdzona</span></div>
            <div class="legend-item"><div class="legend-box legend-available"></div><span>Wolny termin</span></div>
            <div class="legend-item"><div class="legend-box legend-cancelled"></div><span>Odwołana</span></div>
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle" style="margin-bottom: 10px;"></h3>
        <div id="modalButtons" class="modal-buttons"></div>
    </div>
</div>

<script>
    let currentWeekStart = new Date();
    // Ustawienie na poniedziałek bieżącego tygodnia
    const day = currentWeekStart.getDay();
    const diff = currentWeekStart.getDate() - day + (day === 0 ? -6 : 1);
    currentWeekStart.setDate(diff);

    const hours = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];
    const dayNames = ['Pon.', 'Wt.', 'Śr.', 'Czw.', 'Pt.', 'Sob.', 'Ndz.'];

    let editMode = false;
    let currentSlot = null;

    let appointments = {
        '24.12.2025-08:00': { status: 'available' },
        '24.12.2025-09:00': { patient: 'Michał Kowalczyk', status: 'unconfirmed' },
        '24.12.2025-10:00': { patient: 'Jan Kowalski', status: 'confirmed' },
        '24.12.2025-11:00': { status: 'available' },
        '24.12.2025-14:00': { patient: 'Maria Nowak', status: 'unconfirmed' },
        '24.12.2025-15:00': { patient: 'Krystyna Wójcik', status: 'confirmed' },
        '25.12.2025-08:00': { status: 'available' },
        '25.12.2025-09:00': { patient: 'Piotr Wiśniewski', status: 'confirmed' },
        '25.12.2025-10:00': { status: 'available' },
        '25.12.2025-11:00': { patient: 'Elżbieta Kowalczyk', status: 'unconfirmed' },
        '25.12.2025-13:00': { patient: 'Zofia Kamińska', status: 'unconfirmed' },
        '25.12.2025-14:00': { patient: 'Stanisław Mazur', status: 'confirmed' }
    };

    function formatDate(date) {
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        return `${d}.${m}.${y}`;
    }

    function updateCurrentDate() {
        const now = new Date();
        const days = ['Niedziela', 'Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek', 'Sobota'];
        const dayName = days[now.getDay()];
        const timeStr = now.toTimeString().slice(0, 5);
        document.getElementById('currentDate').textContent = `${dayName}, ${formatDate(now)} ${timeStr}`;
    }

    function toggleEditMode() {
        editMode = !editMode;
        const btn = document.getElementById('editBtn');
        btn.textContent = editMode ? 'Zakończ edycję' : 'Edytuj godziny pracy';

        if (editMode) {
            btn.classList.remove('action-btn');
            btn.classList.add('accept-btn');
        } else {
            btn.classList.remove('accept-btn');
            btn.classList.add('action-btn');
        }
        renderCalendar();
    }

    function openModal(timeKey, appointment) {
        currentSlot = timeKey;
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalButtons = document.getElementById('modalButtons');

        modalButtons.innerHTML = '';

        const [dateStr, hour] = timeKey.split('-');
        const [day, month, year] = dateStr.split('.');
        const appointmentDate = new Date(year, month - 1, day);
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        const isPast = appointmentDate < today;

        if (!appointment) {
            modalTitle.textContent = 'Wolny termin';
            modalButtons.innerHTML = `
                <button class="def-btn" onclick="setAvailable()">Ustaw jako wolny termin</button>
                <div class="modal-option">
                    <label>
                        <input type="checkbox" id="applyToWeek">
                        <span>Ustaw na każdy dzień tego tygodnia o ${hour}</span>
                    </label>
                </div>
                <div class="modal-option">
                    <label>
                        <input type="checkbox" id="applyToAllWeeks">
                        <span>Powtarzaj co tydzień (przez 3 miesiące)</span>
                    </label>
                </div>
                <button class="action-btn" onclick="closeModal()">Anuluj</button>
            `;
        } else if (appointment.status === 'cancelled') {
            modalTitle.textContent = 'Wizyta odwołana';
            modalButtons.innerHTML = `
                <p>Ta wizyta została już odwołana.</p>
                <button class="action-btn" onclick="closeModal()">Zamknij</button>
            `;
        } else if (appointment.status === 'available') {
            modalTitle.textContent = 'Edycja wolnego terminu';
            modalButtons.innerHTML = `
                <button class="delete-btn" onclick="removeSlot()">Usuń wolny termin</button>
                <div class="modal-option">
                    <label>
                        <input type="checkbox" id="removeFromAllWeeks">
                        <span>Usuń z każdego tygodnia (cyklicznie)</span>
                    </label>
                </div>
                <button class="action-btn" onclick="closeModal()">Anuluj</button>
            `;
        } else if (isPast) {
            modalTitle.textContent = `Archiwum: ${appointment.patient}`;
            modalButtons.innerHTML = `
                <p>Wizyta historyczna. Brak możliwości edycji.</p>
                <button class="action-btn" onclick="closeModal()">Zamknij</button>
            `;
        } else if (appointment.status === 'unconfirmed') {
            modalTitle.textContent = `Wizyta: ${appointment.patient}`;
            modalButtons.innerHTML = `
                <button class="accept-btn" onclick="confirmAppointment()">Potwierdź wizytę</button>
                <button class="delete-btn" onclick="cancelAppointment()">Odwołaj wizytę</button>
                <button class="action-btn" onclick="closeModal()">Anuluj</button>
            `;
        } else if (appointment.status === 'confirmed') {
            modalTitle.textContent = `Wizyta: ${appointment.patient}`;
            modalButtons.innerHTML = `
                <button class="delete-btn" onclick="cancelAppointment()">Odwołaj wizytę</button>
                <button class="action-btn" onclick="closeModal()">Anuluj</button>
            `;
        }

        modal.style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        currentSlot = null;
    }

    // --- LOGIKA DODAWANIA TERMINÓW (POPRAWIONA) ---

    function setAvailable() {
        const applyToWeek = document.getElementById('applyToWeek').checked;
        const applyToAllWeeks = document.getElementById('applyToAllWeeks').checked;

        // Pobieramy godzinę i datę z klikniętego slotu
        const [dateStr, hour] = currentSlot.split('-');
        const [d, m, y] = dateStr.split('.');
        const selectedDate = new Date(y, m - 1, d);

        // Funkcja pomocnicza: dodaje slot, jeśli nie koliduje z inną wizytą
        const addSlot = (dateObj) => {
            const key = `${formatDate(dateObj)}-${hour}`;
            // Jeśli slot jest pusty LUB jest już ustawiony jako available - nadpisz.
            // Jeśli jest tam pacjent (confirmed/unconfirmed/cancelled) - NIE RUSZAJ.
            if (!appointments[key] || appointments[key].status === 'available') {
                appointments[key] = { status: 'available' };
            }
        };

        const WEEKS_LIMIT = 12; // Ile tygodni w przód wypełniać (np. 3 miesiące)

        if (applyToWeek && applyToAllWeeks) {
            // SCENARIUSZ: "Cały tydzień" + "Powtarzaj" = Codziennie przez 12 tygodni
            for (let w = 0; w < WEEKS_LIMIT; w++) {
                for (let i = 0; i < 7; i++) {
                    const targetDate = new Date(currentWeekStart);
                    // Startujemy od poniedziałku bieżącego widoku + przesunięcie tygodni + dzień
                    targetDate.setDate(targetDate.getDate() + (w * 7) + i);
                    addSlot(targetDate);
                }
            }
        } else if (applyToWeek) {
            // SCENARIUSZ: Tylko ten tydzień (od Pon do Ndz w aktualnym widoku)
            for (let i = 0; i < 7; i++) {
                const targetDate = new Date(currentWeekStart); // currentWeekStart to zawsze poniedziałek widoku
                targetDate.setDate(targetDate.getDate() + i);
                addSlot(targetDate);
            }
        } else if (applyToAllWeeks) {
            // SCENARIUSZ: Tylko ten jeden dzień tygodnia (np. Wtorek), cyklicznie
            for (let w = 0; w < WEEKS_LIMIT; w++) {
                const targetDate = new Date(selectedDate);
                targetDate.setDate(targetDate.getDate() + (w * 7));
                addSlot(targetDate);
            }
        } else {
            // SCENARIUSZ: Pojedynczy slot
            addSlot(selectedDate);
        }

        closeModal();
        renderCalendar();
    }

    // --- LOGIKA USUWANIA TERMINÓW (POPRAWIONA) ---

    function removeSlot() {
        const removeFromAllWeeks = document.getElementById('removeFromAllWeeks');
        const [dateStr, hour] = currentSlot.split('-');
        const [d, m, y] = dateStr.split('.');
        const selectedDate = new Date(y, m - 1, d);

        if (removeFromAllWeeks && removeFromAllWeeks.checked) {
            const WEEKS_LIMIT = 12;
            for (let w = 0; w < WEEKS_LIMIT; w++) {
                const targetDate = new Date(selectedDate);
                targetDate.setDate(targetDate.getDate() + (w * 7));
                const key = `${formatDate(targetDate)}-${hour}`;

                // Usuwamy tylko jeśli to "wolny termin", nie usuwamy wizyt pacjentów
                if (appointments[key] && appointments[key].status === 'available') {
                    delete appointments[key];
                }
            }
        } else {
            delete appointments[currentSlot];
        }

        closeModal();
        renderCalendar();
    }

    function confirmAppointment() {
        if(appointments[currentSlot]) appointments[currentSlot].status = 'confirmed';
        closeModal();
        renderCalendar();
    }

    function cancelAppointment() {
        if(appointments[currentSlot]) appointments[currentSlot].status = 'cancelled';
        closeModal();
        renderCalendar();
    }

    function renderCalendar() {
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        document.getElementById('weekRange').textContent =
            `${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}`;

        for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + i);
            document.getElementById(`day${i}`).textContent =
                `${dayNames[i]} ${formatDate(date).slice(0,5)}`;
        }

        const body = document.getElementById('calendarBody');
        body.innerHTML = '';

        hours.forEach(hour => {
            const row = document.createElement('div');
            row.className = 'calendar-row';

            const timeCell = document.createElement('div');
            timeCell.className = 'time-cell';
            timeCell.textContent = hour;
            row.appendChild(timeCell);

            for (let day = 0; day < 7; day++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';

                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + day);
                const dateKey = formatDate(date);
                const timeKey = `${dateKey}-${hour}`;

                const appointment = appointments[timeKey];

                if (appointment) {
                    cell.classList.add(appointment.status);
                    if (appointment.patient) {
                        const apt = document.createElement('div');
                        apt.className = 'appointment';
                        apt.textContent = appointment.patient;
                        cell.appendChild(apt);
                    }
                } else {
                    cell.classList.add('empty');
                }

                if (editMode || (appointment && appointment.patient)) {
                    cell.onclick = () => openModal(timeKey, appointment);
                    if(editMode) cell.style.cursor = 'pointer';
                }

                row.appendChild(cell);
            }

            body.appendChild(row);
        });
    }

    function previousWeek() {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderCalendar();
    }

    function nextWeek() {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderCalendar();
    }

    window.onclick = function(event) {
        if(event.target == document.getElementById('modal')) {
            closeModal();
        }
    }

    updateCurrentDate();
    renderCalendar();
    setInterval(updateCurrentDate, 60000);
</script>

</body>
</html>